@startuml

skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false
autonumber

title System Sequence Diagram : US03 - Add a city

actor Editor
participant AddCityUI
participant AddCityController
participant Repositories
participant MapRepository
participant CurrentSession
participant CurrentEditor
participant AddHouseBlocksController
participant City
participant Map
participant HouseBlock

activate Editor
Editor -> AddCityUI : asks to add a city
activate AddCityUI
AddCityUI --> AddCityController : create()
activate AddCityController

' Check current session and editor first
AddCityController -> CurrentSession : getInstance()
activate CurrentSession
CurrentSession --> AddCityController : currentSession
deactivate CurrentSession
AddCityController -> CurrentSession : getEditor()
activate CurrentSession
CurrentSession --> AddCityController : currentEditor
deactivate CurrentSession
AddCityController -> CurrentEditor : isAuthorized("addCity")
activate CurrentEditor
CurrentEditor --> AddCityController : true
deactivate CurrentEditor

AddCityUI -> AddCityController : getAvailableMaps()
AddCityController -> Repositories : getInstance()
activate Repositories
Repositories --> AddCityController : repositories
deactivate Repositories
AddCityController -> Repositories : mapRepository()
activate Repositories
Repositories --> AddCityController : mapRepository
deactivate Repositories
AddCityController -> MapRepository : getMaps()
activate MapRepository
MapRepository --> AddCityController : mapsList
deactivate MapRepository
AddCityController --> AddCityUI : mapsList
deactivate AddCityController
AddCityUI -> Editor : shows a list of maps
deactivate AddCityUI

Editor -> AddCityUI : selects a map
activate AddCityUI

AddCityUI -> Editor : asks for city name
deactivate AddCityUI
Editor -> AddCityUI : inputs name
activate AddCityUI
AddCityUI -> AddCityController : validateName(name)
activate AddCityController
AddCityController -> AddCityController : checkNoDigitsOrSpecialChars()
AddCityController --> AddCityUI : true
deactivate AddCityController

AddCityUI -> Editor : asks for coordinates
deactivate AddCityUI
Editor -> AddCityUI : inputs coordinates
activate AddCityUI
AddCityUI -> AddCityController : validateCoordinates(coordinates)
activate AddCityController
AddCityController --> AddCityUI : true
deactivate AddCityController
AddCityUI -> Editor : asks number of house blocks
deactivate AddCityUI
Editor -> AddCityUI : inputs number
activate AddCityUI
AddCityUI -> AddCityController : validateNumberPositive()
activate AddCityController
AddCityController --> AddCityUI : true
deactivate AddCityController

AddCityUI -> Editor : ask if assign blocks manually
deactivate AddCityUI
Editor -> AddCityUI : selects yes/no
activate AddCityUI
AddCityUI -> AddHouseBlocksController : assignBlocks(manual/auto, numBlocks, map, cityCoordinates)
activate AddHouseBlocksController
loop for each block
AddHouseBlocksController -> HouseBlock : setHouseBlockCoordinate()
activate HouseBlock
HouseBlock --> AddHouseBlocksController : true
deactivate HouseBlock
end
AddHouseBlocksController -> City : addBlocks()
activate City
City --> AddHouseBlocksController : true
deactivate City
AddHouseBlocksController --> AddCityUI : true
deactivate AddHouseBlocksController



AddCityUI -> Editor : asks for confirmation
deactivate AddCityUI
Editor -> AddCityUI : confirms

activate AddCityUI
AddCityUI -> AddCityController : saveCity(name, coordinates, houseBlocks)
activate AddCityController
AddCityController -> City : create(name, coordinates, houseBlocks)
activate City
City --> AddCityController : cityObject
deactivate City
AddCityController -> Map : addCity(city)
activate Map
Map --> AddCityController : true
deactivate Map


' Add saving to repository
AddCityController -> Repositories : getInstance()
activate Repositories
Repositories --> AddCityController : repositories
deactivate Repositories
AddCityController -> Repositories : mapRepository()
activate Repositories
Repositories --> AddCityController : mapRepository
deactivate Repositories
AddCityController -> MapRepository : saveMap(map)
activate MapRepository
MapRepository --> AddCityController : true
deactivate MapRepository

AddCityController --> AddCityUI : true
deactivate AddCityController

AddCityUI -> Editor : operation success
deactivate AddCityUI
deactivate Editor

@enduml