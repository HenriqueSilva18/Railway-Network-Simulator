@startuml
'skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

autonumber

'hide footbox
actor "Player" as PLAYER
participant ":BuyLocomotiveUI" as UI
participant ":BuyLocomotiveController" as CTRL
participant "Repositories" as REPOS
participant "repositories\n:Repositories" as REPOS_SINGLETON
participant "locomotiveRepository\n:LocomotiveRepository" as LOC_REPO
participant "ApplicationSession" as APP_SESSION
participant "appSession\n:ApplicationSession" as APP_SESSION_SINGLETON
participant "currentSession\n:UserSession" as CURRENT_SESSION
participant "player\n:Player" as PLAYER_OBJ
participant "locomotive\n:Locomotive" as LOCOMOTIVE
participant "scenarioRepository\n:ScenarioRepository" as SCENARIO_REPO
participant "scenario\n:Scenario" as SCENARIO

activate PLAYER

    PLAYER -> UI : asks to buy a locomotive
    activate UI
        UI --> CTRL** : create()

        UI -> CTRL : getAvailableLocomotives()
        activate CTRL

            CTRL -> REPOS : getInstance()
            activate REPOS
                REPOS --> CTRL : repositories
            deactivate REPOS

            CTRL -> REPOS_SINGLETON : getLocomotiveRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : locomotiveRepository
            deactivate REPOS_SINGLETON

            CTRL -> REPOS_SINGLETON : getScenarioRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : scenarioRepository
            deactivate REPOS_SINGLETON

            CTRL -> SCENARIO_REPO : getCurrentScenario()
            activate SCENARIO_REPO
                SCENARIO_REPO --> CTRL : scenario
            deactivate SCENARIO_REPO

            CTRL -> SCENARIO : getCurrentDate()
            activate SCENARIO
                SCENARIO --> CTRL : currentDate
            deactivate SCENARIO

            CTRL -> LOC_REPO : getAvailableLocomotives(scenario, currentDate)
            activate LOC_REPO
                LOC_REPO --> CTRL : availableLocomotivesList
            deactivate LOC_REPO

            CTRL --> UI : availableLocomotivesList
        deactivate CTRL

        UI --> PLAYER : shows list of available locomotives
    deactivate UI

    PLAYER -> UI : selects a locomotive
    activate UI

        UI -> CTRL : getLocomotiveDetails(locomotiveId)
        activate CTRL

            CTRL -> LOC_REPO : getLocomotiveById(locomotiveId)
            activate LOC_REPO
                LOC_REPO --> CTRL : locomotive
            deactivate LOC_REPO

            CTRL --> UI : locomotive
        deactivate CTRL

        UI --> PLAYER : shows locomotive details and requests confirmation
    deactivate UI

    PLAYER -> UI : confirms purchase
    activate UI

        UI -> CTRL : purchaseLocomotive(locomotiveId)
        activate CTRL

            CTRL -> APP_SESSION : getInstance()
            activate APP_SESSION
                APP_SESSION --> CTRL : appSession
            deactivate APP_SESSION

            CTRL -> APP_SESSION_SINGLETON : getCurrentSession()
            activate APP_SESSION_SINGLETON
                APP_SESSION_SINGLETON --> CTRL : currentSession
            deactivate APP_SESSION_SINGLETON

            CTRL -> CURRENT_SESSION : getCurrentPlayer()
            activate CURRENT_SESSION
                CURRENT_SESSION --> CTRL : player
            deactivate CURRENT_SESSION

            CTRL -> REPOS : getInstance()
            activate REPOS
                REPOS --> CTRL : repositories
            deactivate REPOS

            CTRL -> REPOS_SINGLETON : getLocomotiveRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : locomotiveRepository
            deactivate REPOS_SINGLETON

            CTRL -> LOC_REPO : getLocomotiveById(locomotiveId)
            activate LOC_REPO
                LOC_REPO --> CTRL : locomotive
            deactivate LOC_REPO

            CTRL -> PLAYER_OBJ : canAfford(locomotive.acquisitionPrice)
            activate PLAYER_OBJ
                PLAYER_OBJ --> CTRL : true
            deactivate PLAYER_OBJ

            CTRL -> PLAYER_OBJ : subtractFromBudget(locomotive.acquisitionPrice)
            activate PLAYER_OBJ
                PLAYER_OBJ --> CTRL : success
            deactivate PLAYER_OBJ

            CTRL -> PLAYER_OBJ : addLocomotiveToList(locomotive)
            activate PLAYER_OBJ
                PLAYER_OBJ --> CTRL : success
            deactivate PLAYER_OBJ

            CTRL -> LOCOMOTIVE : setOwner(player)
            activate LOCOMOTIVE
                LOCOMOTIVE --> CTRL : success
            deactivate LOCOMOTIVE

            CTRL --> UI : purchaseResult
        deactivate CTRL

        UI --> PLAYER : displays operation success
    deactivate UI

deactivate PLAYER
@enduml