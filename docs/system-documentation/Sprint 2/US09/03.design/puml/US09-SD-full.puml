@startuml
'skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

autonumber

'hide footbox
actor "Player" as PLAYER
participant ":BuyLocomotiveUI" as UI
participant ":BuyLocomotiveController" as CTRL
participant "Repositories" as REPOS
participant "repositories\n:Repositories" as REPOS_SINGLETON
participant "ApplicationSession" as APP_SESSION
participant "appSession\n:ApplicationSession" as APP_SESSION_SINGLETON
participant "currentSession\n:UserSession" as CURRENT_SESSION
participant "scenarioRepository\n:ScenarioRepository" as SCENARIO_REPO
participant "locomotiveRepository\n:LocomotiveRepository" as LOC_REPO
participant "playerRepository\n:PlayerRepository" as PLAYER_REPO
participant "locomotive\n:Locomotive" as LOCOMOTIVE
participant "player\n:Player" as PLAYER_OBJ
participant "scenario\n:Scenario" as SCENARIO

activate PLAYER

    PLAYER -> UI : asks to buy a locomotive
    activate UI
        UI --> CTRL** : create()

        UI -> CTRL : getAvailableLocomotives()
        activate CTRL
            CTRL -> REPOS : getInstance()
            activate REPOS
                REPOS --> CTRL: repositories
            deactivate REPOS

            CTRL -> APP_SESSION : getInstance()
            activate APP_SESSION
                APP_SESSION --> CTRL : appSession
            deactivate APP_SESSION

            CTRL -> APP_SESSION_SINGLETON : getCurrentSession()
            activate APP_SESSION_SINGLETON
                APP_SESSION_SINGLETON --> CTRL : currentSession
            deactivate APP_SESSION_SINGLETON

            CTRL -> REPOS_SINGLETON : getScenarioRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL: scenarioRepository
            deactivate REPOS_SINGLETON

            CTRL -> REPOS_SINGLETON : getCurrentScenario()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : currentScenario
            deactivate REPOS_SINGLETON

            CTRL -> REPOS_SINGLETON : getCurrentDate()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : currentDate
            deactivate REPOS_SINGLETON

            CTRL -> SCENARIO : getAvailableLocomotives(currentScenario, currentDate)
            activate SCENARIO

                SCENARIO --> CTRL : availableLocomotives
            deactivate SCENARIO

            CTRL --> UI : availableLocomotives
        deactivate CTRL

        UI --> PLAYER : shows a list of available locomotives (for the scenario and current date)
    deactivate UI

    PLAYER -> UI : selects a locomotive
    activate UI

        UI -> CTRL : getLocomotive(locomotiveID)
        activate CTRL
            CTRL -> LOC_REPO : getLocomotive(locomotiveID)
            activate LOC_REPO
                LOC_REPO --> CTRL : locomotive
            deactivate LOC_REPO

            CTRL --> UI : locomotive
        deactivate CTRL

        UI --> PLAYER : shows locomotive details and requests confirmation
    deactivate UI

    PLAYER -> UI : confirms purchase
    activate UI

        UI -> CTRL : purchaseLocomotive(locomotive)
        activate CTRL

        activate CTRL
            CTRL -> CTRL : getPlayerFromSession()
            activate CTRL
                CTRL -> APP_SESSION : getInstance()
                activate APP_SESSION
                    APP_SESSION --> CTRL : appSession
                deactivate APP_SESSION

                CTRL -> APP_SESSION_SINGLETON : getCurrentSession()
                activate APP_SESSION_SINGLETON
                    APP_SESSION_SINGLETON --> CTRL : currentSession
                deactivate APP_SESSION_SINGLETON

                CTRL -> CURRENT_SESSION : getUsername()
                activate CURRENT_SESSION
                    CURRENT_SESSION --> CTRL : username
                deactivate CURRENT_SESSION

                CTRL -> REPOS : getInstance()
                activate REPOS
                    REPOS --> CTRL : repositories
                deactivate REPOS

                CTRL -> REPOS_SINGLETON : getPlayerRepository()
                activate REPOS_SINGLETON
                    REPOS_SINGLETON --> CTRL : playerRepository
                deactivate REPOS_SINGLETON

                CTRL -> PLAYER_REPO : getPlayerByUsername(username)
                activate PLAYER_REPO
                    PLAYER_REPO --> CTRL : player
                deactivate PLAYER_REPO

                CTRL --> CTRL : player
            deactivate CTRL

                CTRL -> LOCOMOTIVE : getPrice()
                activate LOCOMOTIVE
                    LOCOMOTIVE --> CTRL : locomotivePrice
                deactivate LOCOMOTIVE


            CTRL -> CTRL : checkBalance(locomotivePrice, player)
            activate CTRL

                CTRL -> PLAYER_OBJ : hasSufficientMoney(locomotivePrice)
                activate PLAYER_OBJ
                    PLAYER_OBJ --> CTRL : true
                deactivate PLAYER_OBJ

                CTRL --> CTRL : true
            deactivate CTRL

            CTRL -> PLAYER_OBJ : completePurchase(locomotive)
            activate PLAYER_OBJ
                PLAYER_OBJ -> PLAYER_OBJ : removeMoney(locomotivePrice)
                activate PLAYER_OBJ
                    PLAYER_OBJ --> PLAYER_OBJ : true
                deactivate PLAYER_OBJ

                PLAYER_OBJ -> PLAYER_OBJ : addLocomotive(locomotive)
                activate PLAYER_OBJ
                    PLAYER_OBJ --> PLAYER_OBJ : true
                deactivate PLAYER_OBJ

                PLAYER_OBJ --> CTRL : true
            deactivate PLAYER_OBJ

            CTRL -> LOCOMOTIVE : setOwner(player)
            activate LOCOMOTIVE
                LOCOMOTIVE --> CTRL : true
            deactivate LOCOMOTIVE

            CTRL --> UI : true
        deactivate CTRL

        UI --> PLAYER : displays operation success
    deactivate UI

deactivate PLAYER

@enduml