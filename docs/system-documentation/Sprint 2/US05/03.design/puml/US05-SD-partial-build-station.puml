@startuml
skinparam packageStyle rectangle
skinparam shadowing false

participant ":StationBuildingController" as CTRL
participant "ApplicationSession" as APP_SESSION
participant "appSession\n:ApplicationSession" as APP_SESSION_SINGLETON
participant "player\n:Player" as PLAYER_OBJ
participant "map\n:Map" as MAP
participant "station\n:Station" as STATION
participant "Repositories" as REPOS
participant "repositories\n:Repositories" as REPOS_SINGLETON
participant "mapRepository\n:MapRepository" as MAP_REPO

autonumber 29
-> CTRL : buildStation(stationType, position, centerPoint)

autonumber 29.1
activate CTRL
    group Build Station
        ' Get player from session
        CTRL -> APP_SESSION : getInstance()
        activate APP_SESSION
            APP_SESSION --> CTRL : appSession
        deactivate APP_SESSION

        CTRL -> APP_SESSION_SINGLETON : getCurrentSession()
        activate APP_SESSION_SINGLETON
            APP_SESSION_SINGLETON --> CTRL : player
        deactivate APP_SESSION_SINGLETON

        ' Deduct cost from player's budget
        CTRL -> PLAYER_OBJ : deductFromBudget(stationType.getCost())
        activate PLAYER_OBJ
            PLAYER_OBJ --> CTRL : success
        deactivate PLAYER_OBJ

        ' Create station name based on closest city
        CTRL -> MAP : getClosestCity(position)
        activate MAP
            MAP --> CTRL : closestCity
        deactivate MAP

        ' Create the station
        CTRL -> PLAYER_OBJ : buildStation(stationName, position, stationType)
        activate PLAYER_OBJ
            PLAYER_OBJ --> STATION** : create(stationName, position, stationType)
            PLAYER_OBJ --> CTRL : station
        deactivate PLAYER_OBJ

        ' Add station to map
        CTRL -> MAP : addStation(station)
        activate MAP
            MAP --> CTRL : success
        deactivate MAP

        ' Save map with new station
        CTRL -> REPOS : getInstance()
        activate REPOS
            REPOS --> CTRL: repositories
        deactivate REPOS

        CTRL -> REPOS_SINGLETON : getMapRepository()
        activate REPOS_SINGLETON
            REPOS_SINGLETON --> CTRL: mapRepository
        deactivate REPOS_SINGLETON

        CTRL -> MAP_REPO : save(map)
        activate MAP_REPO
            MAP_REPO --> CTRL : success
        deactivate MAP_REPO
    end

    autonumber 30
    <-- CTRL : success
deactivate CTRL

@enduml 