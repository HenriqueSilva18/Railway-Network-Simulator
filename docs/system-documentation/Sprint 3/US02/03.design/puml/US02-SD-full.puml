@startuml
skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false
skinparam sequenceMessageAlign center

title Full Corrected Sequence Diagram: US02 - Add Industry

autonumber

actor "Editor" as editor
participant ":AddIndustryUI" as UI
participant ":AddIndustryController" as CTRL
participant "Repositories" as REPOS
participant "repositories\n:Repositories" as REPOS_SINGLETON
participant ":ApplicationSession" as APP_SESSION

participant "mapRepository\n:MapRepository" as REPOS_MAP
participant "mapMapper\n:MapMapper" as MAPPER_MAP
participant "listMap : List<Map>" as LIST_MAP
participant "maps\n:Maps" as MAPS
participant "listMapDTO\n:List<MapDTO>" as LIST_MAP_DTO
participant "mapDTO\n:MapDTO" as DTO_MAP
participant "currentMap\n:Map" as MAP

participant "scenarioRepository\n:ScenarioRepository" as SCENARIO_REPO
participant "scenarios\n:Scenarios" as SCENARIOS
participant "scenario\n:Scenario" as SCENARIO
participant ":List<Scenario>" as LIST
participant "scenarioRepository\n:ScenarioRepository" as REPOS_SCENARIO
participant ":ScenarioMapper" as SCENARIO_MAPPER
participant "listScenario\n:List<Scenario>" as SCENARIO_LIST
participant "listScenarioDTO\n:List<ScenarioDTO>" as SCENARIO_LIST_DTO
participant "scenarioDTO\n:ScenarioDTO" as SCENARIO_DTO


participant "industries\n:Industries" as INDS
participant ":List<Industry>" as LIST
participant ":IndustryMapper" as IND_MAPPER
participant "listIndustry\n:List<Industry>" as IND_LIST
participant "listIndustryDTO\n:List<IndustryDTO>" as IND_LIST_DTO
participant "industryRepository\n:IndustryRepository" as REPOS_IND

activate editor

editor -> UI : Asks to add an industry
activate UI

    UI -> CTRL**: create()

    UI -> CTRL: getAvailableMaps()
    activate CTRL
        group Get Available Maps
        autonumber 3.1
            CTRL -> REPOS: getInstance()
            activate REPOS
                REPOS --> CTRL : repositories
            deactivate REPOS

            CTRL -> REPOS_SINGLETON : getMapRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : mapRepository
            deactivate REPOS_SINGLETON

            CTRL -> REPOS_MAP : getAvailableMaps()
            activate REPOS_MAP
                REPOS_MAP -> LIST_MAP**: create()
                REPOS_MAP --> CTRL : List<Map>
            deactivate REPOS_MAP

            CTRL -> MAPPER_MAP : toMapDTOs(List<Map>)
            activate MAPPER_MAP
                loop for each map in List<Map>
                MAPPER_MAP -> LIST_MAP: obj = get(i)
                activate LIST_MAP
                deactivate LIST_MAP

                MAPPER_MAP -> MAPPER_MAP : objDTO = toDTO(obj)
                activate MAPPER_MAP
                deactivate MAPPER_MAP

                MAPPER_MAP -> DTO_MAP**: create(...)
                MAPPER_MAP --> LIST_MAP_DTO : add(mapDTO)
                activate LIST_MAP_DTO
                deactivate LIST_MAP_DTO

                end
                MAPPER_MAP --> CTRL : List<MapDTO>
            deactivate MAPPER_MAP
        end
        autonumber 4
        CTRL --> UI: List<MapDTO>
    deactivate CTRL

    UI --> editor: Shows the list of available maps
deactivate UI

editor -> UI: Selects a map
activate UI
    UI -> CTRL: loadMap(mapSelectionDTO)
    activate CTRL
        group Load Selected Map
        autonumber 7.1
            CTRL -> APP_SESSION: getInstance()
            activate APP_SESSION
                 APP_SESSION --> CTRL : appSession
            deactivate APP_SESSION
            CTRL -> APP_SESSION: setCurrentMap(mapId)

            CTRL -> REPOS_MAP : getMapById(mapId)
            activate REPOS_MAP
                REPOS_MAP --> CTRL : currentMap
            deactivate REPOS_MAP

            CTRL -> MAPPER_MAP : toMapLayoutDTO(currentMap)
            activate MAPPER_MAP
                MAPPER_MAP -> DTO_MAP**: create(...)

                MAPPER_MAP --> CTRL : mapLayoutDTO
            deactivate MAPPER_MAP
            autonumber 8
        end
        CTRL --> UI: mapLayoutDTO
    deactivate CTRL
    UI --> editor: Loads and displays the selected map
deactivate UI

editor -> UI: Confirms the selected map
activate UI
    UI -> CTRL: getListOfScenarios(mapDTO)
    autonumber 11.1
    activate CTRL
        group Get ScenarioDTO List


            CTRL -> REPOS_SINGLETON: getMapRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL: mapRepository
            deactivate REPOS_SINGLETON

            CTRL -> DTO_MAP: getNameID()
            activate DTO_MAP
                DTO_MAP --> CTRL: mapNameID
            deactivate DTO_MAP

            CTRL -> REPOS_MAP: getListOfMapScenarios(mapNameID)
            activate REPOS_MAP

            REPOS_MAP -> MAPS: getListOfMapScenarios(mapNameID)
            activate MAPS

            MAPS -> MAP: getScenarios()
            activate MAP

                MAP --> SCENARIOS: getScenarios()
                activate SCENARIOS
                    SCENARIOS --> SCENARIO_LIST**: create()

                    loop for each known Scenario

                        SCENARIOS --> LIST: scenario = get(i)
                        activate LIST
                            deactivate LIST

                        SCENARIOS --> SCENARIO_LIST: add(scenario)
                        activate SCENARIO_LIST
                            deactivate SCENARIO_LIST

                    end

                SCENARIOS --> MAP: listScenario
                deactivate SCENARIOS

                MAP --> MAPS: listScenario
                deactivate MAP

            MAPS --> REPOS_MAP: listScenario
            deactivate MAPS

            REPOS_MAP --> CTRL: listScenario
            deactivate REPOS_MAP


            CTRL -> SCENARIO_MAPPER: toDTO(listScenario)
            activate SCENARIO_MAPPER

                SCENARIO_MAPPER --> SCENARIO_LIST_DTO**: create()

                loop for each object in listScenario
                    SCENARIO_MAPPER -> SCENARIO_LIST: scenario = get(i)
                    activate SCENARIO_LIST
                        deactivate SCENARIO_LIST

                    SCENARIO_MAPPER -> SCENARIO_MAPPER: scenarioDTO = toDTO(scenario)
                    activate SCENARIO_MAPPER
                        deactivate SCENARIO_MAPPER

                    SCENARIO_MAPPER -> SCENARIO_LIST_DTO: add(scenarioDTO)
                    activate SCENARIO_LIST_DTO
                        deactivate SCENARIO_LIST_DTO
                end

            SCENARIO_MAPPER --> CTRL: listScenarioDTO
            deactivate SCENARIO_MAPPER

        end

    autonumber 12
    UI <-- CTRL : listScenarioDTO
deactivate CTRL
    UI --> editor: Shows the list of available scenarios
deactivate UI

editor -> UI: Selects a scenario and confirms
activate UI
    UI -> CTRL: loadScenario(scenarioSelectionDTO)
     activate CTRL
         group Load Selected Scenario


             CTRL -> REPOS_SINGLETON: getScenarioRepository()
             activate REPOS_SINGLETON
                 REPOS_SINGLETON --> CTRL: scenarioRepository
             deactivate REPOS_SINGLETON

             CTRL -> SCENARIO_DTO: getScenarioID()
             activate SCENARIO_DTO
                 SCENARIO_DTO --> CTRL: scenarioID
             deactivate SCENARIO_DTO

             CTRL -> SCENARIO_REPO: getScenario(scenarioID)
             activate SCENARIO_REPO

             SCENARIO_REPO -> SCENARIOS: getScenario(scenarioID)
             activate SCENARIOS

                 SCENARIOS -> SCENARIO: get(scenarioID)
                 activate SCENARIO
                     SCENARIO --> SCENARIOS: scenario
                 deactivate SCENARIO

             SCENARIOS --> SCENARIO_REPO: scenario
             deactivate SCENARIOS

             SCENARIO_REPO --> CTRL: scenario
             deactivate SCENARIO_REPO

             CTRL -> APP_SESSION: getInstance()
             activate APP_SESSION
                 APP_SESSION --> CTRL: appSession
             deactivate APP_SESSION

             CTRL -> APP_SESSION: setCurrentScenario(scenario)
             activate APP_SESSION
                 APP_SESSION --> CTRL: success
             deactivate APP_SESSION

             CTRL -> SCENARIO_MAPPER: toDTO(scenario)
             activate SCENARIO_MAPPER
                 SCENARIO_MAPPER -> SCENARIO_DTO**: create(...)
                 SCENARIO_MAPPER --> CTRL: scenarioDTO
             deactivate SCENARIO_MAPPER

         end

         autonumber 16
         <-- CTRL : scenarioDTO
     deactivate CTRL
     UI --> editor : Loads the selected scenario
deactivate UI

editor -> UI: Confirms the selected scenario
activate UI
    UI -> CTRL: getListOfMapIndustries(mapDTO)
    activate CTRL
        group Get IndustryDTO List

            CTRL -> REPOS_SINGLETON: getMapRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL: mapRepository
            deactivate REPOS_SINGLETON

            CTRL -> DTO_MAP: getNameID()
            activate DTO_MAP
                DTO_MAP --> CTRL: mapNameID
            deactivate DTO_MAP

            CTRL -> REPOS_MAP: getListOfMapIndustries(mapNameID)
            activate REPOS_MAP

            REPOS_MAP -> MAPS: getListOfMapIndustries(mapNameID)
            activate MAPS

            MAPS -> MAP: getIndustries()
            activate MAP

                MAP --> INDS: getIndustries()
                activate INDS
                    INDS --> IND_LIST**: create()

                    loop for each known Industry

                        INDS --> LIST: industry = get(i)
                        activate LIST
                            deactivate LIST

                        INDS --> IND_LIST: add(industry)
                        activate IND_LIST
                            deactivate IND_LIST

                    end

                INDS --> MAP: listIndustry
                deactivate INDS

                MAP --> MAPS: listIndustry
                deactivate MAP

            MAPS --> REPOS_MAP: listIndustry
            deactivate MAPS

            REPOS_MAP --> CTRL: listIndustry
            deactivate REPOS_MAP


            CTRL -> IND_MAPPER: toDTO(listIndustry)
            activate IND_MAPPER

                IND_MAPPER --> IND_LIST_DTO**: create()

                loop for each object in listIndustry
                    IND_MAPPER -> IND_LIST: industry = get(i)
                    activate IND_LIST
                        deactivate IND_LIST

                    IND_MAPPER -> IND_MAPPER: industryDTO = toDTO(industry)
                    activate IND_MAPPER
                        deactivate IND_MAPPER

                    IND_MAPPER -> IND_LIST_DTO: add(industryDTO)
                    activate IND_LIST_DTO
                        deactivate IND_LIST_DTO
                end

            IND_MAPPER --> CTRL: listIndustryDTO
            deactivate IND_MAPPER

        end

        autonumber 16
        CTRL --> UI : listIndustryDTO
    deactivate CTRL
    UI --> editor : Shows the list of available industries
deactivate UI

editor -> UI : Selects an industry
activate UI
UI --> editor : Asks for industry data(nameID, X and Y coordinates, availabilityYear)
deactivate UI

editor -> UI : Provides industry data (name, coords, etc.)
activate UI

    UI -> CTRL : addIndustry(nameID, x, y, availabilityYear)
    activate CTRL
        ' The Controller creates the DTO for validation and confirmation.
        CTRL -> DTO_IND**: create(nameID, x, y, availabilityYear)
        CTRL --> UI : industryDTO
    deactivate CTRL

    UI --> editor : Shows industry data and asks for confirmation
deactivate UI

editor -> UI : Confirms the data
activate UI
    UI -> CTRL : confirmAddIndustry(industryDTO)
    activate CTRL
        group Domain Logic: Create and Add Industry
            ' The Controller delegates creation to the Repository, passing the DTO.
            CTRL -> REPOS_SINGLETON : getIndustryRepository()
             activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : industryRepository
            deactivate REPOS_SINGLETON

            CTRL -> REPOS_IND : save(industryDTO)
            activate REPOS_IND
                ' The Repository uses the Mapper to create the domain object from the DTO.
                REPOS_IND -> IND_MAPPER : toDomain(industryDTO)
                activate IND_MAPPER
                    IND_MAPPER -> DTO_IND : getNameID()
                    IND_MAPPER -> DTO_IND : getX()
                    IND_MAPPER -> DTO_IND : getY()
                    ' ... gets other attributes
                    IND_MAPPER -> IND**: create(nameID, x, y, ...)
                    IND_MAPPER --> REPOS_IND : newIndustry
                deactivate IND_MAPPER

                ' The Repository persists the new domain object.
                REPOS_IND -> IND : // stores the new object
                REPOS_IND --> CTRL : newIndustry
            deactivate REPOS_IND

            ' The Controller orchestrates adding the industry to the map.
            CTRL -> MAP : addIndustry(newIndustry)
            activate MAP
                MAP --> CTRL : success
            deactivate MAP

            ' The Controller requests persistence of the map state.
            CTRL -> REPOS_MAP : save(currentMap)
            activate REPOS_MAP
                REPOS_MAP --> CTRL : success
            deactivate REPOS_MAP

            ' The Controller uses the Mapper to create a details DTO for the UI.
            CTRL -> IND_MAPPER : toDetailsDTO(newIndustry)
            activate IND_MAPPER
                 IND_MAPPER -> DTO_IND**: create(...)
                 IND_MAPPER --> CTRL : industryDetailsDTO
            deactivate IND_MAPPER
        end

        CTRL --> UI : industryDetailsDTO
    deactivate CTRL

    UI --> editor : Displays success message and the\ndetails of the added industry
deactivate UI

deactivate editor
@enduml